name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - uses: golangci/golangci-lint-action@v7

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.out

  release-latest:
    name: Release Latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --snapshot --clean

      - name: Update latest release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # copy raw binaries from build subdirs to dist/ root for direct download
          for f in dist/podproxy_*_v*/podproxy; do
            dir_name=$(basename "$(dirname "$f")")
            archive_name=$(echo "$dir_name" | sed 's/_v[0-9.].*$//')
            cp "$f" "dist/${archive_name}"
          done

          gh release delete latest --yes --cleanup-tag 2>/dev/null || true
          gh release create latest \
            dist/podproxy_darwin_amd64 \
            dist/podproxy_darwin_arm64 \
            dist/podproxy_linux_amd64 \
            dist/podproxy_linux_arm64 \
            dist/podproxy_darwin_amd64.tar.gz \
            dist/podproxy_darwin_arm64.tar.gz \
            dist/podproxy_linux_amd64.tar.gz \
            dist/podproxy_linux_arm64.tar.gz \
            dist/checksums.txt \
            --title "Latest Build" \
            --notes "Built from commit ${GITHUB_SHA::7} on $(date -u +%Y-%m-%d)" \
            --prerelease

      - name: Publish snapshot formula to Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          REPO="entwico/podproxy"
          RELEASE_TAG="latest"

          darwin_amd64_sha=$(sha256sum dist/podproxy_darwin_amd64.tar.gz | awk '{print $1}')
          darwin_arm64_sha=$(sha256sum dist/podproxy_darwin_arm64.tar.gz | awk '{print $1}')
          linux_amd64_sha=$(sha256sum dist/podproxy_linux_amd64.tar.gz | awk '{print $1}')
          linux_arm64_sha=$(sha256sum dist/podproxy_linux_arm64.tar.gz | awk '{print $1}')

          BASE_URL="https://github.com/${REPO}/releases/download/${RELEASE_TAG}"

          cat > /tmp/podproxy-latest.rb <<FORMULA
          # typed: false
          # frozen_string_literal: true

          class PodproxyLatest < Formula
            desc "Kubernetes pod proxy that routes traffic through pod port-forwarding"
            homepage "https://github.com/${REPO}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "${BASE_URL}/podproxy_darwin_arm64.tar.gz"
                sha256 "${darwin_arm64_sha}"
              else
                url "${BASE_URL}/podproxy_darwin_amd64.tar.gz"
                sha256 "${darwin_amd64_sha}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "${BASE_URL}/podproxy_linux_arm64.tar.gz"
                sha256 "${linux_arm64_sha}"
              else
                url "${BASE_URL}/podproxy_linux_amd64.tar.gz"
                sha256 "${linux_amd64_sha}"
              end
            end

            def install
              bin.install "podproxy"
              (etc/"podproxy").install "defaults.yaml" => "config.yaml" unless (etc/"podproxy/config.yaml").exist?
            end

            service do
              run [opt_bin/"podproxy", "--config", etc/"podproxy/config.yaml"]
              keep_alive true
              log_path var/"log/podproxy.log"
              error_log_path var/"log/podproxy.log"
              working_dir var
            end

            def caveats
              <<~EOS
                Configuration file:
                  #{etc}/podproxy/config.yaml

                A default config is installed if one does not already exist.
                Edit it before starting the service:
                  $EDITOR #{etc}/podproxy/config.yaml

                To start podproxy as a background service:
                  brew services start #{name}

                To stop the service:
                  brew services stop #{name}

                Logs are written to:
                  #{var}/log/podproxy.log
              EOS
            end

            test do
              system "#{bin}/podproxy", "--version"
            end
          end
          FORMULA

          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/entwico/homebrew-tap.git" /tmp/homebrew-tap
          mkdir -p /tmp/homebrew-tap/Formula
          cp /tmp/podproxy-latest.rb /tmp/homebrew-tap/Formula/podproxy-latest.rb
          cd /tmp/homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/podproxy-latest.rb
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update podproxy-latest formula to ${GITHUB_SHA::7}"
          git push

  docker:
    name: Docker
    needs: [lint, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: build --clean

      - name: Copy binaries for Docker build
        run: |
          for f in dist/podproxy_linux_*/podproxy; do
            dir_name=$(basename "$(dirname "$f")")
            archive_name=$(echo "$dir_name" | sed 's/_v[0-9.].*$//')
            cp "$f" "dist/${archive_name}"
          done

      - uses: docker/setup-qemu-action@v3

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/entwico/podproxy
          tags: |
            type=raw,value=latest
            type=sha,prefix=sha-

      - uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
